@{
    System.Globalization.CultureInfo CI = (System.Globalization.CultureInfo)Session["Culture"];
}

<div id="ordersHeader">
    <h3 style="padding-left: .5em;">@Machete.Web.Resources.Reports.ordersHeader</h3>
    <div id="ordersPopup">
        <p style="padding-left: .5em;">
        @Machete.Web.Resources.Reports.ordersInstructions
        <input type="button" value="Hide" class="formButton" id="orderHide" />
        </p>
    </div>
</div>

<div id="ordersReports">
    <h3><a href="#" id="jzcLink">Jobs and Zip Codes (Mountain View)</a></h3>
    <div id="jzcTable">
        <span style="display:block;">
        <input type="button" value="Data Refresh" class="formButton" id="jzcDataRefreshBtn" />
        <input type="button" value="Pie Chart" class="formButton" id="jzcPieChartBtn" />
        <input type="button" value="Print Report" class="formButton" id="jzcPrintReport" />
        <input type="button" value="Spreadsheet Export" class="formButton" id="jzcSpreadsheet" />
        </span>
        <span style="display:block;">
            @Html.TextBox("activeDate", @DateTime.Now.ToShortDateString(), new { @style = "height: 2em;width: 6em;border-radius:.5em;text-align:center;font-weight:bold;", @class = "ui-datepicker", @id = "jzcDate" })
        <p id="jzcHelp" style="display:inline;"><em>Select a date and click "Submit" to see results.</em></p>
        </span>
        <table id="jzcDataTable" class="display">
            <thead>
                <tr>
                    <th>@Machete.Web.Resources.Reports.date</th>
                    <th>@Machete.Web.Resources.Reports.jzcZipCodes</th>
                    <th style="width:50%;">@Machete.Web.Resources.Reports.jzcJobs</th>
                </tr>
            </thead>
        </table>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        //hide stuff
        $('#jzcTable').hide();
        $('#jzcHelp').hide();

        //click to hide stuff
        $('#orderHide').click(
            function () {
                $('#ordersPopup').hide();
            });

        //accordion stuff
        $('#ordersReports').accordion({
            collapsible: true,
            active: false,
            autoHeight: false
        });

        //make stuff pretty
        $('#orderHide').button();
        $('#jzcDataRefreshBtn').button();
        $('#jzcPieChartBtn').button();
        $('#jzcPrintReport').button();
        $('#jzcSpreadsheet').button();

        //make stuff do stuff
        //
        //
        //
        /////////////////DATATABLES///////////////
        var jzcTableDefaults = {
            "bPaginate": false, // to enable pagination (this report has fixed size)
            "bAutoWidth": false,
            "bDestroy": false,
            "bInfo": true, //shows information about data being displayed on the page
            "bSort": false, //enable or disable sorting of columns
            "bFilter": false, //enable or disable filtering of data
            "bServerSide": true, //server side processing, req. source
            "sAjaxSource": "/Reports/AjaxJobsZipCodes", //source for server side processing
            "bProcessing": false, //enable processing indicator
            "oLanguage": datatable_lang_@(CI.TwoLetterISOLanguageName), //internationalisation
            "aoColumns": [
                { mDataProp: "date" },
                { mDataProp: "topZips" },
                { mDataProp: "topJobs" }
            ], //these are the column names in the array; total # must match
            "fnServerData": function (sSource, aoData, fnCallback) {
                aoData.push({ "name": "todaysdate", "value": $('#jzcDate').val() });
                $.getJSON(sSource, aoData, function (json) {
                    /* Do whatever additional processing you want on the callback, then tell DataTables */
                    fnCallback(json)
                });
            }
        };
        //
        var jzcNewTable = jQuery.extend(true, {}, jzcTableDefaults);
        //
        jzcNewTable["bDestroy"] = "true,";
        //
        //
        //GO
        $('#jzcLink').click(function () {
            $('#jzcDataTable').dataTable(jzcNewTable);
        });


        //////////////JSONTOCSV//////////////
        // Credit and thanks: http://stackoverflow.com/users/64741/zachary
        function JSON2CSV(objArray) {
            var array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;

            var str = '';
            var line = '';
            var head = array[0];

            for (var index in array[0]) {
                line += index + ',';
            }

            line = line.slice(0, -1);
            str += line + '\r\n';

            for (var i = 0; i < array.length; i++) {
                var line = '';

                for (var index in array[i]) {
                    line += array[i][index] + ',';
                }

                line = line.slice(0, -1);
                str += line + '\r\n';

            }


            return str;
        };
    



        ////////////////////DATEPICKER/////////////////
        $('.ui-datepicker').datepicker({
            autoSize: true,
            changeMonth: true,
            changeYear: true,
            constrainInput: true,
            dateFormat: 'mm/dd/yy',
            duration: "slow",
            showButtonPanel: false,
            showOn: "focus"
        });

        $('.ui-datepicker').hover(
            function () {
                $('#jzcHelp').show("fade", 1100);
            },
            function () {
                $('#jzcHelp').hide("fade", 1100);
            });

        $('.ui-datepicker').change(
        function (event) {
            jzcNewTable["todaysdate"] = $('#jzcDate').val();
            $('#jzcDataTable').dataTable(jzcNewTable).fnReloadAjax();
        });

        $('#jzcDataRefreshBtn').click(
            function () {
                jzcNewTable["todaysdate"] = $('#jzcDate').val();
                $('#jzcDataTable').dataTable(jzcNewTable).fnReloadAjax();
            });

        $('#jzcSpreadsheet').click(
            function () {
                var url = "/Reports/AjaxJobsZipCodes";
                var date = $('#jzcDate').val();
                var getit = $.getJSON(url,
                    {
                        todaysdate: date
                    });
                var csv = JSON2CSV(getit); //the offending line
                window.open("data:text/csv;charset=utf-8," + escape(csv));    
            });
    });
</script>